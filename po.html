<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç­ç´šæ¦®è­½çœ‹æ¿ - å­¸ç”Ÿç‰ˆ</title>
    
    <style>
        :root { --primary: #6200ee; --bg: #f8f9fa; --text: #333; }
        body { font-family: "Microsoft JhengHei", -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 15px; color: var(--text); }
        .container { max-width: 600px; margin: auto; }
        
        h2 { text-align: center; margin-top: 20px; color: var(--primary); }
        #statusInfo { text-align: center; color: #888; font-size: 0.9em; margin-bottom: 20px; }

        /* ç­ç´šé¸æ“‡æŒ‰éˆ• */
        .class-selection { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; margin-bottom: 25px; }
        .btn-class { 
            background: white; border: 1px solid #ddd; padding: 12px 8px; 
            border-radius: 12px; font-weight: bold; cursor: pointer; text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: 0.2s;
        }
        .btn-class.active { border: 2px solid var(--primary); background: #f0ebff; color: var(--primary); transform: translateY(-2px); }
        .teacher-label { display: block; font-size: 0.75em; color: #999; margin-bottom: 3px; font-weight: normal; }

        /* æ’åºæ§åˆ¶ */
        .sort-bar { display: flex; justify-content: center; gap: 8px; margin-bottom: 20px; }
        .btn-sort { padding: 8px 20px; border-radius: 20px; border: 1px solid #ccc; background: white; cursor: pointer; font-size: 0.9em; transition: 0.3s; }
        .btn-sort.active { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 4px 10px rgba(98,0,238,0.2); }

        /* å­¸ç”Ÿåˆ—è¡¨ï¼šæ ¸å¿ƒä¿®æ­£è™• */
        .student-list { display: flex; flex-direction: column; gap: 10px; }
        .student-row { 
            display: flex; 
            align-items: center; 
            background: white; 
            padding: 15px 20px; 
            border-radius: 15px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }
        
        /* å­¸è™Ÿæ¬„ä½ï¼šå›ºå®šå¯¬åº¦ï¼Œç¢ºä¿ä¸èˆ‡å§“åç›¸é» */
        .id-col { 
            width: 70px; 
            color: #999; 
            font-family: 'Courier New', monospace; 
            font-size: 1.1em;
            flex-shrink: 0; /* ç¦æ­¢ç¸®å° */
        }
        
        /* å§“åæ¬„ä½ï¼šè‡ªå‹•å¡«æ»¿ä¸­é–“ç©ºé–“ */
        .name-col { 
            flex-grow: 1; 
            font-size: 1.3em; 
            font-weight: 600;
            padding-left: 10px;
        }
        
        /* åˆ†æ•¸æ¬„ä½ï¼šå³å°é½Š */
        .score-col { 
            font-size: 1.8em; 
            font-weight: 900; 
            color: var(--primary);
            min-width: 60px;
            text-align: right;
        }

        .hidden { display: none; }
        .loader { text-align: center; padding: 40px; color: #aaa; font-style: italic; }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸ† ç­ç´šåŠ åˆ†çœ‹æ¿</h2>
    <div id="statusInfo">é€£ç·šä¸­...</div>
    
    <div id="classButtons" class="class-selection"></div>

    <div id="displayArea" class="hidden">
        <div class="sort-bar">
            <button id="sortId" class="btn-sort active" onclick="changeSort('id', 'asc')">æŒ‰å­¸è™Ÿæ’åº</button>
            <button id="sortScore" class="btn-sort" onclick="changeSort('totalScore', 'desc')">æŒ‰åˆ†æ•¸æ’å</button>
        </div>
        
        <h3 id="viewTitle" style="text-align: center; color: #555; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px;"></h3>
        <div id="studentList" class="student-list"></div>
    </div>
    
    <div id="msgBox" class="loader">è«‹é»é¸ä¸Šæ–¹ç­ç´šæŸ¥çœ‹</div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, onSnapshot, query, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // --- è«‹æ›¿æ›ç‚ºæ‚¨çš„ Firebase è¨­å®š ---
    const firebaseConfig = {
       apiKey: "AIzaSyCTUNT7oU2kNhqaF1qSuXjpQVrGJL3BXsc",
        authDomain: "score-a4e5b.firebaseapp.com",
        projectId: "score-a4e5b",
        storageBucket: "score-a4e5b.firebasestorage.app",
        messagingSenderId: "158303926526",
        appId: "1:158303926526:web:2485978b314a5536210daf"

    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let currentUnsub = null;
    let selectedId = "";
    let selectedTeacher = "";

    async function loadAllClasses() {
        const btnArea = document.getElementById('classButtons');
        const status = document.getElementById('statusInfo');
        try {
            const snap = await getDocs(collection(db, "classes"));
            if (snap.empty) {
                status.innerText = "è³‡æ–™åº«ç›®å‰æ²’æœ‰ç­ç´š";
                return;
            }
            btnArea.innerHTML = "";
            snap.forEach(doc => {
                const data = doc.data();
                const btn = document.createElement('div');
                btn.className = 'btn-class';
                btn.innerHTML = `<span class="teacher-label">${data.teacherId || 'è€å¸«'}</span>${doc.id}`;
                btn.onclick = () => {
                    selectedId = doc.id;
                    selectedTeacher = data.teacherId;
                    setActiveButton(btn);
                    changeSort('id', 'asc');
                };
                btnArea.appendChild(btn);
            });
            status.innerText = "è«‹é¸æ“‡ç­ç´š";
        } catch (e) {
            status.innerText = "è®€å–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ã€‚";
        }
    }

    function setActiveButton(activeBtn) {
        document.querySelectorAll('.btn-class').forEach(b => b.classList.remove('active'));
        activeBtn.classList.add('active');
        document.getElementById('displayArea').classList.remove('hidden');
        document.getElementById('msgBox').classList.add('hidden');
    }

    window.changeSort = (field, direction) => {
        document.querySelectorAll('.btn-sort').forEach(b => b.classList.remove('active'));
        if(field === 'id') document.getElementById('sortId').classList.add('active');
        else document.getElementById('sortScore').classList.add('active');

        if (currentUnsub) currentUnsub();
        
        document.getElementById('viewTitle').innerText = `${selectedTeacher} è€å¸« - ${selectedId}`;
        const listDiv = document.getElementById('studentList');
        listDiv.innerHTML = "<div class='loader'>è®€å–ä¸­...</div>";

        const q = query(collection(db, "classes", selectedId, "students"), orderBy(field, direction));
        
        currentUnsub = onSnapshot(q, (snapshot) => {
            listDiv.innerHTML = "";
            snapshot.forEach(doc => {
                const s = doc.data();
                const row = document.createElement('div');
                row.className = 'student-row';
                row.innerHTML = `
                    <div class="id-col">${s.id}</div>
                    <div class="name-col">${s.name}</div>
                    <div class="score-col">${s.totalScore}</div>
                `;
                listDiv.appendChild(row);
            });
        }, (error) => {
            listDiv.innerHTML = `<div class='loader' style='color:red;'>éŒ¯èª¤ï¼š${error.message}</div>`;
        });
    };

    loadAllClasses();
</script>

</body>
</html>
