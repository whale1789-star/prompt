<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç­ç´šçœ‹æ¿ - é è¨­å­¸è™Ÿæ’åº</title>
    <style>
        :root { --primary: #6200ee; --bg: #f4f7f6; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 15px; }
        .container { max-width: 600px; margin: auto; }
        
        /* ç­ç´šé¸æ“‡æŒ‰éˆ• */
        .class-selection { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .btn-class { 
            background: white; border: 1px solid #ddd; padding: 15px; 
            border-radius: 10px; font-weight: bold; cursor: pointer; text-align: center;
        }
        .btn-class.active { border: 2px solid var(--primary); color: var(--primary); background: #f0ebff; }

        /* æ’åºåˆ‡æ›æŒ‰éˆ• */
        .sort-controls { display: flex; justify-content: center; gap: 10px; margin-bottom: 15px; }
        .btn-sort { padding: 8px 15px; border-radius: 20px; border: 1px solid #ccc; background: white; font-size: 0.9em; cursor: pointer; }
        .btn-sort.active { background: var(--primary); color: white; border-color: var(--primary); }

        /* å­¸ç”Ÿåˆ— */
        .student-row { 
            display: flex; align-items: center; background: white; 
            margin-bottom: 8px; padding: 12px 18px; border-radius: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .id-badge { width: 60px; color: #888; font-family: monospace; font-size: 1.1em; }
        .name-box { flex: 1; font-size: 1.2em; font-weight: 600; }
        .score-box { font-size: 1.5em; font-weight: bold; color: var(--primary); }

        .hidden { display: none; }
    </style>
</head>
<body>

<div class="container">
    <h2 style="text-align: center;">ğŸ‘¨â€ğŸ“ ç­ç´šåŠ åˆ†çœ‹æ¿</h2>
    
    <div id="classButtons" class="class-selection">
        <p style="grid-column: 1/3; text-align: center; color: #999;">æ­£åœ¨è¼‰å…¥ç­ç´š...</p>
    </div>

    <div id="displayArea" class="hidden">
        <div class="sort-controls">
            <button id="sortById" class="btn-sort active" onclick="changeSort('id', 'asc')">æŒ‰å­¸è™Ÿæ’åº</button>
            <button id="sortByScore" class="btn-sort" onclick="changeSort('totalScore', 'desc')">æŒ‰åˆ†æ•¸æ’å</button>
        </div>
        
        <h3 id="currentTitle" style="text-align: center; color: #555;"></h3>
        <div id="studentList"></div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, onSnapshot, query, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "YOUR_API_KEY",
        authDomain: "YOUR_PROJECT.firebaseapp.com",
        projectId: "YOUR_PROJECT_ID",
        storageBucket: "...",
        messagingSenderId: "...",
        appId: "..."
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    let currentUnsub = null;
    let selectedClassId = "";
    let selectedTeacher = "";

    // 1. åˆå§‹åŒ–ç­ç´šæŒ‰éˆ•
    async function init() {
        const btnArea = document.getElementById('classButtons');
        const snap = await getDocs(collection(db, "classes"));
        btnArea.innerHTML = "";
        
        snap.forEach(doc => {
            const data = doc.data();
            const btn = document.createElement('div');
            btn.className = 'btn-class';
            btn.innerHTML = `<small style="display:block; color:#888;">${data.teacherId || ''}</small>${doc.id}`;
            btn.onclick = () => {
                selectedClassId = doc.id;
                selectedTeacher = data.teacherId;
                document.querySelectorAll('.btn-class').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById('displayArea').classList.remove('hidden');
                changeSort('id', 'asc'); // é è¨­é€²ä¾†å°±æ˜¯å­¸è™Ÿæ’åº
            };
            btnArea.appendChild(btn);
        });
    }

    // 2. åˆ‡æ›æ’åºé‚è¼¯
    window.changeSort = (field, direction) => {
        // æ›´æ–° UI ç‹€æ…‹
        document.querySelectorAll('.btn-sort').forEach(b => b.classList.remove('active'));
        if(field === 'id') document.getElementById('sortById').classList.add('active');
        else document.getElementById('sortByScore').classList.add('active');

        if (currentUnsub) currentUnsub();
        
        document.getElementById('currentTitle').innerText = `${selectedTeacher}è€å¸« - ${selectedClassId}`;
        
        // æ ¸å¿ƒæ’åºæŸ¥è©¢
        const q = query(collection(db, "classes", selectedClassId, "students"), orderBy(field, direction));
        
        currentUnsub = onSnapshot(q, (snapshot) => {
            const listDiv = document.getElementById('studentList');
            listDiv.innerHTML = "";
            snapshot.forEach(doc => {
                const s = doc.data();
                const row = document.createElement('div');
                row.className = 'student-row';
                row.innerHTML = `
                    <div class="id-badge">${s.id}</div>
                    <div class="name-box">${s.name}</div>
                    <div class="score-box">${s.totalScore}</div>
                `;
                listDiv.appendChild(row);
            });
        });
    };

    init();
</script>
</body>
</html>
