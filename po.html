<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç­ç´šæ¦®è­½æ¦œ - å­¸ç”Ÿçœ‹æ¿</title>
    <style>
        :root { --gold: #FFD700; --silver: #C0C0C0; --bronze: #CD7F32; --primary: #6200ee; }
        body { font-family: -apple-system, sans-serif; background: #f0f2f5; margin: 0; padding: 15px; }
        .container { max-width: 600px; margin: auto; }
        
        /* ç­ç´šé¸æ“‡æŒ‰éˆ•å€ */
        .class-selection { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .btn-class { 
            background: white; border: 2px solid #ddd; padding: 15px 10px; 
            border-radius: 12px; font-weight: bold; cursor: pointer;
            text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            transition: 0.2s;
        }
        .btn-class:hover, .btn-class.active { border-color: var(--primary); background: #eeeefc; color: var(--primary); }
        .teacher-tag { display: block; font-size: 0.8em; color: #888; margin-bottom: 4px; }

        /* æ’è¡Œæ¦œ */
        .rank-card { 
            display: flex; align-items: center; background: white; 
            margin-bottom: 10px; padding: 15px; border-radius: 12px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .rank-num { width: 45px; font-size: 1.5em; font-weight: bold; text-align: center; }
        .rank-1 { background: linear-gradient(135deg, #fffceb, #fff); border: 2px solid var(--gold); }
        
        .student-info { flex: 1; margin-left: 10px; }
        .student-name { font-size: 1.25em; font-weight: bold; }
        .score-val { font-size: 1.6em; font-weight: bold; color: var(--primary); }

        h2 { text-align: center; color: #333; margin-top: 25px; }
        #loading { text-align: center; color: #888; padding: 20px; }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸ† é¸æ“‡ç­ç´šæ¦®è­½æ¦œ</h2>
    <div id="loading">æ­£åœ¨é€£ç·šè³‡æ–™åº«...</div>
    
    <div id="classButtons" class="class-selection"></div>

    <hr style="border:0; border-top:1px solid #ddd; margin: 30px 0;">

    <div id="rankDisplay" class="hidden">
        <h3 id="currentViewTitle" style="text-align:center; color: var(--primary);"></h3>
        <div id="rankList"></div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, onSnapshot, query, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
       apiKey: "AIzaSyCTUNT7oU2kNhqaF1qSuXjpQVrGJL3BXsc",
        authDomain: "score-a4e5b.firebaseapp.com",
        projectId: "score-a4e5b",
        storageBucket: "score-a4e5b.firebasestorage.app",
        messagingSenderId: "158303926526",
        appId: "1:158303926526:web:2485978b314a5536210daf"

    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    let currentUnsub = null;

    // 1. åˆå§‹è¼‰å…¥ï¼šæŠ“å–æ‰€æœ‰ç­ç´šä¸¦è£½ä½œæŒ‰éˆ•
    async function initClassList() {
        const btnArea = document.getElementById('classButtons');
        const loader = document.getElementById('loading');
        
        try {
            const querySnapshot = await getDocs(collection(db, "classes"));
            loader.style.display = 'none';
            
            if (querySnapshot.empty) {
                btnArea.innerHTML = "<p style='grid-column: 1/3; text-align:center;'>ç›®å‰å°šç„¡ç­ç´šè³‡æ–™</p>";
                return;
            }

            querySnapshot.forEach((doc) => {
                const classData = doc.data();
                const classId = doc.id;
                const teacher = classData.teacherId || "æœªçŸ¥è€å¸«";

                const btn = document.createElement('div');
                btn.className = 'btn-class';
                btn.innerHTML = `<span class="teacher-tag">${teacher} è€å¸«</span> ${classId}`;
                btn.onclick = () => {
                    // åˆ‡æ›æŒ‰éˆ•æ¨£å¼
                    document.querySelectorAll('.btn-class').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    loadRank(classId, teacher);
                };
                btnArea.appendChild(btn);
            });
        } catch (e) {
            loader.innerText = "è®€å–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šã€‚";
        }
    }

    // 2. è¼‰å…¥ç‰¹å®šç­ç´šçš„å³æ™‚æ’å
    function loadRank(classId, teacher) {
        // å¦‚æœæœ‰èˆŠçš„ç›£è½å™¨ï¼Œå…ˆé—œé–‰
        if (currentUnsub) currentUnsub();

        document.getElementById('currentViewTitle').innerText = `âœ¨ ${teacher} è€å¸« - ${classId} æ¦®è­½æ¦œ âœ¨`;
        const listDiv = document.getElementById('rankList');
        listDiv.innerHTML = "<p style='text-align:center;'>è¼‰å…¥ä¸­...</p>";

        const q = query(collection(db, "classes", classId, "students"), orderBy("totalScore", "desc"));
        
        currentUnsub = onSnapshot(q, (snapshot) => {
            listDiv.innerHTML = "";
            let rank = 1;

            snapshot.forEach((doc) => {
                const s = doc.data();
                const item = document.createElement('div');
                item.className = `rank-card ${rank === 1 ? 'rank-1' : ''}`;
                
                let medal = rank;
                if(rank === 1) medal = "ğŸ¥‡";
                else if(rank === 2) medal = "ğŸ¥ˆ";
                else if(rank === 3) medal = "ğŸ¥‰";

                item.innerHTML = `
                    <div class="rank-num">${medal}</div>
                    <div class="student-info">
                        <span class="student-name">${s.name}</span>
                    </div>
                    <div class="score-val">${s.totalScore}</div>
                `;
                listDiv.appendChild(item);
                rank++;
            });
        });
    }

    initClassList();
</script>
</body>
</html>
