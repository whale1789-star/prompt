<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç­ç´šæ¦®è­½çœ‹æ¿ - å­¸ç”Ÿç‰ˆ</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-global.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-global.js"></script>
    <style>
        :root { --primary: #6200ee; --bg: #f8f9fa; }
        body { font-family: "Microsoft JhengHei", -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 15px; }
        .container { max-width: 600px; margin: auto; }
        
        /* æ¨™é¡Œèˆ‡ç‹€æ…‹ */
        h2 { text-align: center; color: #333; margin-top: 20px; }
        #statusInfo { text-align: center; color: #666; font-size: 0.9em; margin-bottom: 20px; }

        /* ç­ç´šé¸æ“‡æŒ‰éˆ• */
        .class-selection { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 25px; }
        .btn-class { 
            background: white; border: 1px solid #ddd; padding: 15px 10px; 
            border-radius: 12px; font-weight: bold; cursor: pointer; text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: 0.2s;
        }
        .btn-class.active { border: 2px solid var(--primary); background: #f0ebff; color: var(--primary); }
        .teacher-label { display: block; font-size: 0.75em; color: #999; margin-bottom: 3px; }

        /* æ’åºæ§åˆ¶ */
        .sort-bar { display: flex; justify-content: center; gap: 8px; margin-bottom: 20px; }
        .btn-sort { padding: 8px 16px; border-radius: 20px; border: 1px solid #ccc; background: white; cursor: pointer; font-size: 0.9em; }
        .btn-sort.active { background: var(--primary); color: white; border-color: var(--primary); }

        /* å­¸ç”Ÿåˆ—è¡¨ */
        .student-list { display: flex; flex-direction: column; gap: 8px; }
        .student-row { 
            display: flex; align-items: center; background: white; 
            padding: 15px 20px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.03);
        }
        .id-col { width: 50px; color: #888; font-weight: bold; }
        .name-col { flex: 1; font-size: 1.2em; font-weight: 500; }
        .score-col { font-size: 1.6em; font-weight: 800; color: var(--primary); }

        .hidden { display: none; }
        .loader { text-align: center; padding: 40px; color: #aaa; }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸ† ç­ç´šåŠ åˆ†çœ‹æ¿</h2>
    <div id="statusInfo">æ­£åœ¨åŒæ­¥è³‡æ–™åº«...</div>
    
    <div id="classButtons" class="class-selection"></div>

    <div id="displayArea" class="hidden">
        <div class="sort-bar">
            <button id="sortId" class="btn-sort active" onclick="changeSort('id', 'asc')">æŒ‰å­¸è™Ÿæ’åº</button>
            <button id="sortScore" class="btn-sort" onclick="changeSort('totalScore', 'desc')">æŒ‰åˆ†æ•¸æ’å</button>
        </div>
        
        <h3 id="viewTitle" style="text-align: center; color: #444; margin-bottom: 15px;"></h3>
        <div id="studentList" class="student-list"></div>
    </div>
    
    <div id="msgBox" class="loader">è«‹å…ˆé¸æ“‡ä¸Šæ–¹ç­ç´š</div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, onSnapshot, query, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // --- ã€é‡è¦ã€‘è«‹æ›¿æ›ç‚ºæ‚¨çš„ Firebase è¨­å®š ---
    const firebaseConfig = {
      apiKey: "AIzaSyCTUNT7oU2kNhqaF1qSuXjpQVrGJL3BXsc",
        authDomain: "score-a4e5b.firebaseapp.com",
        projectId: "score-a4e5b",
        storageBucket: "score-a4e5b.firebasestorage.app",
        messagingSenderId: "158303926526",
        appId: "1:158303926526:web:2485978b314a5536210daf"

    };

    // åˆå§‹åŒ– Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let currentUnsub = null;
    let selectedId = "";
    let selectedTeacher = "";

    // A. åˆå§‹è¼‰å…¥ï¼šç²å–æ‰€æœ‰ç­ç´šæ¸…å–®
    async function loadAllClasses() {
        const btnArea = document.getElementById('classButtons');
        const status = document.getElementById('statusInfo');
        
        try {
            const snap = await getDocs(collection(db, "classes"));
            if (snap.empty) {
                status.innerText = "è³‡æ–™åº«å…§ç›®å‰æ²’æœ‰ç­ç´šè³‡æ–™";
                return;
            }

            btnArea.innerHTML = "";
            snap.forEach(doc => {
                const data = doc.data();
                const btn = document.createElement('div');
                btn.className = 'btn-class';
                btn.innerHTML = `<span class="teacher-label">${data.teacherId || 'è€å¸«'}</span>${doc.id}`;
                btn.onclick = () => {
                    selectedId = doc.id;
                    selectedTeacher = data.teacherId;
                    setActiveButton(btn);
                    changeSort('id', 'asc'); // é è¨­é€²ä¾†æ˜¯å­¸è™Ÿæ’åº
                };
                btnArea.appendChild(btn);
            });
            status.innerText = "è«‹é¸æ“‡ç­ç´šæŸ¥çœ‹åˆ†æ•¸";
        } catch (e) {
            console.error(e);
            status.innerText = "é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ Firebase é…ç½®æˆ–è¦å‰‡";
        }
    }

    function setActiveButton(activeBtn) {
        document.querySelectorAll('.btn-class').forEach(b => b.classList.remove('active'));
        activeBtn.classList.add('active');
        document.getElementById('displayArea').classList.remove('hidden');
        document.getElementById('msgBox').classList.add('hidden');
    }

    // B. åˆ‡æ›æ’åºä¸¦ç›£è½è³‡æ–™
    window.changeSort = (field, direction) => {
        // æ›´æ–°æŒ‰éˆ•æ¨£å¼
        document.querySelectorAll('.btn-sort').forEach(b => b.classList.remove('active'));
        if(field === 'id') document.getElementById('sortId').classList.add('active');
        else document.getElementById('sortScore').classList.add('active');

        // æ¸…é™¤èˆŠç›£è½
        if (currentUnsub) currentUnsub();
        
        document.getElementById('viewTitle').innerText = `${selectedTeacher}è€å¸« - ${selectedId}`;
        const listDiv = document.getElementById('studentList');
        listDiv.innerHTML = "<div class='loader'>è¼‰å…¥è³‡æ–™ä¸­...</div>";

        // å»ºç«‹æŸ¥è©¢
        const q = query(collection(db, "classes", selectedId, "students"), orderBy(field, direction));
        
        // å•Ÿå‹•å³æ™‚ç›£è½
        currentUnsub = onSnapshot(q, (snapshot) => {
            listDiv.innerHTML = "";
            if (snapshot.empty) {
                listDiv.innerHTML = "<div class='loader'>æœ¬ç­ç´šå°šç„¡å­¸ç”Ÿè³‡æ–™</div>";
                return;
            }

            snapshot.forEach(doc => {
                const s = doc.data();
                const row = document.createElement('div');
                row.className = 'student-row';
                row.innerHTML = `
                    <div class="id-col">${s.id}</div>
                    <div class="name-col">${s.name}</div>
                    <div class="score-col">${s.totalScore}</div>
                `;
                listDiv.appendChild(row);
            });
        }, (error) => {
            console.error("ç›£è½å¤±æ•—:", error);
            listDiv.innerHTML = `<div class='loader' style='color:red;'>ç„¡æ³•è®€å–ï¼š${error.message}<br>å¯èƒ½æ˜¯ç¼ºå°‘ç´¢å¼•ï¼Œè«‹æŸ¥çœ‹ Consoleã€‚</div>`;
        });
    };

    // å•Ÿå‹•
    loadAllClasses();
</script>

</body>
</html>
