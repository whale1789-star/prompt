<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>èª²å ‚åŠ æ‰£åˆ†ç³»çµ±</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        :root { --primary: #6200ee; --success: #28a745; --danger: #dc3545; }
        body { font-family: -apple-system, sans-serif; background-color: #f8f9fa; margin: 0; padding: 10px; }
        .container { max-width: 600px; margin: auto; }
        .hidden { display: none !important; }

        /* è€å¸«é¸æ“‡ä»‹é¢ */
        #loginSection { text-align: center; padding: 50px 20px; }
        .teacher-btn { width: 100%; padding: 25px; margin: 15px 0; font-size: 1.5em; border-radius: 15px; border: none; background: white; box-shadow: 0 4px 15px rgba(0,0,0,0.1); cursor: pointer; }
        .teacher-btn:active { transform: scale(0.98); }

        /* ç®¡ç†å€åŸŸ */
        #adminSection { background: white; padding: 20px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .class-badge { display: inline-block; padding: 10px 15px; background: #e0e0e0; margin: 5px; border-radius: 20px; cursor: pointer; font-weight: bold; }
        
        /* è©•åˆ†å€åŸŸï¼šå¤§å­—å¤§æŒ‰éˆ• */
        .student-row { display: flex; align-items: center; background: white; padding: 15px; border-radius: 12px; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .student-info { flex: 1; }
        .student-name { font-size: 1.4em; font-weight: bold; }
        .score-box { font-size: 2em; font-weight: bold; color: var(--primary); min-width: 60px; text-align: center; }
        .btn-ctrl { width: 60px; height: 60px; font-size: 1.8em; border: none; border-radius: 50%; color: white; margin-left: 10px; display: flex; align-items: center; justify-content: center; }
        
        input { padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
    </style>
</head>
<body>

<div class="container">
    <div id="loginSection">
        <h2 style="margin-bottom: 30px;">è«‹é¸æ“‡æ‚¨çš„å§“å</h2>
        <button class="teacher-btn" onclick="teacherLogin('è¬å°å¸ƒ', '0980835')">è¬å°å¸ƒ è€å¸«</button>
        <button class="teacher-btn" onclick="teacherLogin('æé€¸è', '0910813')">æé€¸è è€å¸«</button>
    </div>

    <div id="adminSection" class="hidden">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h3 id="welcomeMsg">è€å¸«æ‚¨å¥½</h3>
            <button onclick="location.reload()" style="background:none; border:none; color:blue;">åˆ‡æ›è€å¸«</button>
        </div>
        <p>æ‚¨çš„ç­ç´šï¼š</p>
        <div id="classList">è®€å–ä¸­...</div>
        
        <hr style="margin: 20px 0;">
        <h4>â• å»ºç«‹/åŒ¯å…¥æ–°ç­ç´š</h4>
        <input type="text" id="classIdInput" placeholder="æ–°ç­ç´šåç¨± (å¦‚: 101)" style="width:100%;">
        <input type="file" id="csvFileInput" accept=".csv" style="margin-top:10px; width:100%;">
        <button onclick="handleImport()" style="margin-top:10px; width:100%; background: #333; color:white; padding:12px; border-radius:8px; font-weight:bold;">åŸ·è¡ŒåŒ¯å…¥</button>
        
        <button class="teacher-btn" style="font-size:12px; padding:10px; color:red; margin-top:30px;" onclick="deleteClassPrompt()">ğŸ”¥ æ¸…é™¤ç‰¹å®šç­ç´š</button>
    </div>

    <div id="scoreSection" class="hidden">
        <div style="display:flex; justify-content:space-between; padding:10px;">
            <button onclick="showAdmin()" style="border:none; padding:8px;">â¬… è¿”å›</button>
            <h3 id="currentClassName">ç­ç´š</h3>
            <button onclick="exportToExcel()" style="background:#007bff; color:white; border:none; border-radius:5px; padding:5px 10px;">åŒ¯å‡º</button>
        </div>
        <input type="text" id="searchInput" placeholder="ğŸ” æœå°‹å­¸ç”Ÿå§“å..." oninput="renderStudents()" style="width:100%; margin-bottom:15px;">
        <div id="studentListArea"></div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, doc, updateDoc, increment, addDoc, serverTimestamp, onSnapshot, getDocs, writeBatch, query, where, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // --- Firebase é…ç½® (è«‹æ›¿æ›ç‚ºæ‚¨çš„å¯†é‘°) ---
    const firebaseConfig = {
       apiKey: "AIzaSyCTUNT7oU2kNhqaF1qSuXjpQVrGJL3BXsc",
        authDomain: "score-a4e5b.firebaseapp.com",
        projectId: "score-a4e5b",
        storageBucket: "score-a4e5b.firebasestorage.app",
        messagingSenderId: "158303926526",
        appId: "1:158303926526:web:2485978b314a5536210daf"

    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    let allStudents = [];
    let currentClassId = "";
    let currentTeacher = "";

    // è€å¸«ç™»å…¥é‚è¼¯
    window.teacherLogin = async (name, cardNo) => {
        const now = new Date();
        const dateStr = `${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}`;
        const correctPassword = cardNo + dateStr;
        
        const inputPass = prompt(`æ‚¨å¥½ ${name} è€å¸«ï¼Œè«‹è¼¸å…¥ç™»å…¥å¯†ç¢¼ (å¡è™Ÿ+æ—¥æœŸ)ï¼š`);
        
        if (inputPass === correctPassword) {
            currentTeacher = name;
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('adminSection').classList.remove('hidden');
            document.getElementById('welcomeMsg').innerText = `${name} è€å¸«ï¼Œæ‚¨å¥½`;
            fetchTeacherClasses();
        } else {
            alert("å¯†ç¢¼éŒ¯èª¤ï¼æ ¼å¼æ‡‰ç‚ºï¼šå¡è™Ÿ + YYYYMMDD");
        }
    };

    // è®€å–è©²è€å¸«å°ˆå±¬ç­ç´š
    async function fetchTeacherClasses() {
        const classListDiv = document.getElementById('classList');
        const q = query(collection(db, "classes"), where("teacherId", "==", currentTeacher));
        const querySnapshot = await getDocs(q);
        
        if (querySnapshot.empty) {
            classListDiv.innerHTML = "å°šæœªå»ºç«‹ç­ç´šã€‚";
            return;
        }
        classListDiv.innerHTML = "";
        querySnapshot.forEach((doc) => {
            const badge = document.createElement('div');
            badge.className = 'class-badge';
            badge.innerText = doc.id;
            badge.onclick = () => loadClass(doc.id);
            classListDiv.appendChild(badge);
        });
    }

    // åŒ¯å…¥æ–°ç­ç´š (ç¶å®šè€å¸« ID)
    window.handleImport = () => {
        const classId = document.getElementById('classIdInput').value.trim();
        const fileInput = document.getElementById('csvFileInput');
        if (!classId || !fileInput.files[0]) return alert("è«‹å¡«å¯«ç­ç´šåç¨±ä¸¦é¸æ“‡æª”æ¡ˆ");

        Papa.parse(fileInput.files[0], {
            header: true,
            complete: async (results) => {
                const batch = writeBatch(db);
                // é—œéµï¼šå°‡æ­¤ç­ç´šæ¨™è¨˜ç‚ºè©²è€å¸«æ‰€æœ‰
                batch.set(doc(db, "classes", classId), { 
                    teacherId: currentTeacher, 
                    createdAt: serverTimestamp() 
                });
                results.data.forEach(s => {
                    if(!s.id || !s.name) return;
                    const ref = doc(db, "classes", classId, "students", s.id);
                    batch.set(ref, { id: s.id, name: s.name, totalScore: 0 });
                });
                await batch.commit();
                alert("åŒ¯å…¥æˆåŠŸï¼");
                fetchTeacherClasses();
            }
        });
    };

    // é€²å…¥ç­ç´šè©•åˆ†
    window.loadClass = (classId) => {
        currentClassId = classId;
        document.getElementById('adminSection').classList.add('hidden');
        document.getElementById('scoreSection').classList.remove('hidden');
        document.getElementById('currentClassName').innerText = classId;
        onSnapshot(collection(db, "classes", classId, "students"), (snapshot) => {
            allStudents = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderStudents();
        });
    };

    window.showAdmin = () => {
        document.getElementById('scoreSection').classList.add('hidden');
        document.getElementById('adminSection').classList.remove('hidden');
    };

    window.renderStudents = () => {
        const term = document.getElementById('searchInput').value.toLowerCase();
        const area = document.getElementById('studentListArea');
        area.innerHTML = allStudents
            .filter(s => s.name.includes(term) || s.id.includes(term))
            .map(s => `
                <div class="student-row">
                    <div class="student-info">
                        <span class="student-name">${s.name}</span><br>
                        <small style="color:#888">${s.id}</small>
                    </div>
                    <div class="score-box">${s.totalScore}</div>
                    <button class="btn-ctrl" style="background:#dc3545;" onclick="changeScore('${s.id}', '${s.name}', -1)">âˆ’</button>
                    <button class="btn-ctrl" style="background:#28a745;" onclick="changeScore('${s.id}', '${s.name}', 1)">+</button>
                </div>
            `).join('');
    };

    window.changeScore = async (sid, sname, val) => {
        const sRef = doc(db, "classes", currentClassId, "students", sid);
        await updateDoc(sRef, { totalScore: increment(val) });
        await addDoc(collection(db, "scoreLogs"), {
            classId: currentClassId, teacherId: currentTeacher, studentName: sname, change: val, timestamp: serverTimestamp()
        });
        if (navigator.vibrate) navigator.vibrate(40);
    };

    window.exportToExcel = () => {
        const ws = XLSX.utils.json_to_sheet(allStudents);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "æˆç¸¾å–®");
        XLSX.writeFile(wb, `${currentClassId}_${currentTeacher}_æˆç¸¾.xlsx`);
    };

    // åˆªé™¤é‚è¼¯ (åŒæ¨£éœ€è¦å¯†ç¢¼)
    window.deleteClassPrompt = async () => {
        const target = prompt("è«‹è¼¸å…¥è¦åˆªé™¤çš„ç­ç´šåç¨±ï¼š");
        if(!target) return;
        const now = new Date();
        const pwd = `${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}`;
        if(prompt("è«‹è¼¸å…¥åˆªé™¤å¯†ç¢¼ï¼š") === pwd) {
            const batch = writeBatch(db);
            const snaps = await getDocs(collection(db, "classes", target, "students"));
            snaps.forEach(d => batch.delete(d.ref));
            batch.delete(doc(db, "classes", target));
            await batch.commit();
            alert("å·²åˆªé™¤");
            fetchTeacherClasses();
        }
    };
</script>
</body>
</html>

