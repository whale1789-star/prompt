<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>èª²å ‚è©•åˆ†ç³»çµ± - å°ˆæ¥­ç‰ˆ</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        :root { --primary: #6200ee; --success: #28a745; --danger: #dc3545; --warning: #ff9800; }
        body { font-family: -apple-system, sans-serif; background-color: #f8f9fa; margin: 0; padding: 10px; }
        .container { max-width: 600px; margin: auto; }

        #adminSection { background: white; padding: 20px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .class-badge { display: inline-block; padding: 10px 15px; background: #e0e0e0; margin: 5px; border-radius: 20px; cursor: pointer; font-weight: bold; }
        .class-badge:hover { background: var(--primary); color: white; }

        .student-list { display: flex; flex-direction: column; gap: 10px; }
        .student-row { display: flex; align-items: center; background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .student-info { flex: 1; }
        .student-name { font-size: 1.4em; font-weight: bold; display: block; }
        .student-id { font-size: 0.8em; color: #888; }
        .score-box { font-size: 2em; font-weight: bold; color: var(--primary); min-width: 60px; text-align: center; }
        
        .btn-ctrl { width: 60px; height: 60px; font-size: 1.8em; border: none; border-radius: 50%; color: white; cursor: pointer; margin-left: 10px; display: flex; align-items: center; justify-content: center; }
        .btn-plus { background-color: var(--success); }
        .btn-minus { background-color: var(--danger); }
        
        /* åˆªé™¤å°ˆç”¨æ¨£å¼ */
        .danger-zone { margin-top: 30px; border-top: 2px dashed #eee; padding-top: 20px; }
        .btn-delete { background: none; color: #aaa; border: 1px solid #ddd; padding: 5px 10px; border-radius: 5px; font-size: 12px; cursor: pointer; }
        .btn-delete:hover { background: var(--danger); color: white; border-color: var(--danger); }

        .hidden { display: none !important; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; padding: 10px; }
        .btn-back { background: #eee; border: none; padding: 5px 10px; border-radius: 5px; }
    </style>
</head>
<body>

<div class="container">
    <div id="adminSection">
        <h3>ğŸ« é¸æ“‡ç­ç´š</h3>
        <div id="classList">æ­£åœ¨è®€å–å·²åŒ¯å…¥ç­ç´š...</div>
        
        <hr style="margin: 20px 0;">
        
        <h4>â• åŒ¯å…¥æ–°ç­ç´š</h4>
        <input type="text" id="classIdInput" placeholder="æ–°ç­ç´šåç¨± (å¦‚: 101)">
        <input type="file" id="csvFileInput" accept=".csv" style="margin-top:10px; width: 100%;">
        <button onclick="handleImport()" style="margin-top:10px; width:100%; background: #333; color:white; padding:12px; border-radius:8px; font-weight: bold;">åŸ·è¡Œé¦–æ¬¡åŒ¯å…¥</button>

        <div class="danger-zone">
            <p style="color:#888; font-size:12px;">â€» å¦‚éœ€åˆªé™¤ç­ç´šï¼Œè«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•</p>
            <button class="btn-delete" onclick="deleteClassPrompt()">ğŸ”¥ æ¸…é™¤ç‰¹å®šç­ç´šè³‡æ–™</button>
        </div>
    </div>

    <div id="scoreSection" class="hidden">
        <div class="top-bar">
            <button class="btn-back" onclick="location.reload()">â¬… è¿”å›</button>
            <h3 id="currentClassName">ç­ç´šåç¨±</h3>
            <button class="btn-back" onclick="exportToExcel()" style="background:#007bff; color:white;">åŒ¯å‡º</button>
        </div>
        <input type="text" id="searchInput" placeholder="ğŸ” æœå°‹å­¸ç”Ÿå§“å..." oninput="renderStudents()" style="width:100%; padding:15px; border-radius:10px; border:1px solid #ddd; margin-bottom:15px; font-size:16px; box-sizing: border-box;">
        <div id="studentListArea" class="student-list"></div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, doc, updateDoc, increment, addDoc, serverTimestamp, onSnapshot, getDocs, writeBatch, deleteDoc, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCTUNT7oU2kNhqaF1qSuXjpQVrGJL3BXsc",
        authDomain: "score-a4e5b.firebaseapp.com",
        projectId: "score-a4e5b",
        storageBucket: "score-a4e5b.firebasestorage.app",
        messagingSenderId: "158303926526",
        appId: "1:158303926526:web:2485978b314a5536210daf"

    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    let allStudents = [];
    let currentClassId = "";

    // åˆå§‹è¼‰å…¥ç­ç´šåˆ—è¡¨
    async function fetchClasses() {
        const classListDiv = document.getElementById('classList');
        const querySnapshot = await getDocs(collection(db, "classes"));
        if (querySnapshot.empty) {
            classListDiv.innerHTML = "å°šæœªæœ‰ä»»ä½•ç­ç´šã€‚";
            return;
        }
        classListDiv.innerHTML = "";
        querySnapshot.forEach((doc) => {
            const badge = document.createElement('div');
            badge.className = 'class-badge';
            badge.innerText = doc.id;
            badge.onclick = () => loadClass(doc.id);
            classListDiv.appendChild(badge);
        });
    }
    fetchClasses();

    // åˆªé™¤ç­ç´šé‚è¼¯
    window.deleteClassPrompt = async () => {
        const targetClass = prompt("è«‹è¼¸å…¥æ¬²åˆªé™¤çš„ç­ç´šåç¨±ï¼š");
        if (!targetClass) return;

        // ç”Ÿæˆç•¶å¤©å¹´æœˆæ—¥ 8 ç¢¼å¯†ç¢¼
        const now = new Date();
        const yyyy = now.getFullYear();
        const mm = String(now.getMonth() + 1).padStart(2, '0');
        const dd = String(now.getDate()).padStart(2, '0');
        const todayPassword = `${yyyy}${mm}${dd}`;

        const password = prompt(`ç¢ºå®šåˆªé™¤ã€Œ${targetClass}ã€å—ï¼Ÿ\nè³‡æ–™åˆªé™¤å¾Œç„¡æ³•å¾©åŸã€‚\nè«‹è¼¸å…¥å¯†ç¢¼ (ç•¶å¤©å¹´æœˆæ—¥å…±8ç¢¼)ï¼š`);
        
        if (password === todayPassword) {
            if (confirm(`è­¦å‘Šï¼šå³å°‡åˆªé™¤ ${targetClass} çš„æ‰€æœ‰å­¸ç”Ÿèˆ‡åˆ†æ•¸ï¼`)) {
                await executeDelete(targetClass);
            }
        } else {
            alert("å¯†ç¢¼éŒ¯èª¤ï¼Œåˆªé™¤æ“ä½œå·²å–æ¶ˆã€‚");
        }
    };

    async function executeDelete(classId) {
        try {
            const batch = writeBatch(db);
            
            // 1. åˆªé™¤è©²ç­ç´šä¸‹çš„æ‰€æœ‰å­¸ç”Ÿ
            const studentSnapshot = await getDocs(collection(db, "classes", classId, "students"));
            studentSnapshot.forEach((sDoc) => {
                batch.delete(doc(db, "classes", classId, "students", sDoc.id));
            });

            // 2. åˆªé™¤ç­ç´šä¸»æ–‡ä»¶
            batch.delete(doc(db, "classes", classId));

            await batch.commit();
            alert("ç­ç´šè³‡æ–™å·²æˆåŠŸæ¸…é™¤ï¼");
            location.reload();
        } catch (e) {
            console.error(e);
            alert("åˆªé™¤å¤±æ•—ï¼Œè«‹ç¢ºèªè©²ç­ç´šæ˜¯å¦å­˜åœ¨ã€‚");
        }
    }

    window.loadClass = (classId) => {
        currentClassId = classId;
        document.getElementById('adminSection').classList.add('hidden');
        document.getElementById('scoreSection').classList.remove('hidden');
        document.getElementById('currentClassName').innerText = classId;
        onSnapshot(collection(db, "classes", classId, "students"), (snapshot) => {
            allStudents = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderStudents();
        });
    };

    window.renderStudents = () => {
        const term = document.getElementById('searchInput').value.toLowerCase();
        const area = document.getElementById('studentListArea');
        area.innerHTML = allStudents
            .filter(s => s.name.includes(term) || s.id.includes(term))
            .map(s => `
                <div class="student-row">
                    <div class="student-info">
                        <span class="student-name">${s.name}</span>
                        <span class="student-id">${s.id}</span>
                    </div>
                    <div class="score-box">${s.totalScore}</div>
                    <button class="btn-ctrl btn-minus" onclick="changeScore('${s.id}', '${s.name}', -1)">âˆ’</button>
                    <button class="btn-ctrl btn-plus" onclick="changeScore('${s.id}', '${s.name}', 1)">+</button>
                </div>
            `).join('');
    };

    window.changeScore = async (sid, sname, val) => {
        const sRef = doc(db, "classes", currentClassId, "students", sid);
        await updateDoc(sRef, { totalScore: increment(val) });
        await addDoc(collection(db, "scoreLogs"), {
            classId: currentClassId, studentId: sid, studentName: sname, change: val, timestamp: serverTimestamp()
        });
    };

    window.handleImport = () => {
        const classId = document.getElementById('classIdInput').value.trim();
        const fileInput = document.getElementById('csvFileInput');
        if (!classId || !fileInput.files[0]) return alert("è«‹è¼¸å…¥ç­ç´šåç¨±ä¸¦é¸æ“‡ CSV");

        Papa.parse(fileInput.files[0], {
            header: true,
            complete: async (results) => {
                const batch = writeBatch(db);
                batch.set(doc(db, "classes", classId), { createdAt: serverTimestamp() });
                results.data.forEach(s => {
                    if(!s.id || !s.name) return;
                    const ref = doc(db, "classes", classId, "students", s.id);
                    batch.set(ref, { id: s.id, name: s.name, totalScore: 0 });
                });
                await batch.commit();
                alert("åŒ¯å…¥æˆåŠŸï¼");
                location.reload();
            }
        });
    };

    window.exportToExcel = () => {
        const ws = XLSX.utils.json_to_sheet(allStudents);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "æˆç¸¾å–®");
        XLSX.writeFile(wb, `${currentClassId}_æˆç¸¾çµç®—.xlsx`);
    };
</script>
</body>
</html>
