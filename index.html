<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èª²å ‚è©•åˆ†ç³»çµ± - å¿«é€Ÿæ“ä½œç‰ˆ</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; padding: 15px; background-color: #f5f7f9; }
        .container { max-width: 800px; margin: auto; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        
        .header-box { background: #fff; padding: 15px; border-bottom: 2px solid #eee; margin-bottom: 20px; }
        .input-group { display: flex; gap: 8px; margin-bottom: 10px; flex-wrap: wrap; }
        
        input { padding: 12px; border: 1px solid #ddd; border-radius: 8px; flex: 1; min-width: 150px; font-size: 16px; }
        button { padding: 12px 18px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: 0.2s; }
        
        .btn-load { background-color: #6200ee; color: white; } /* é€²å…¥ç­ç´š */
        .btn-import { background-color: #03dac6; color: #000; } /* åŒ¯å…¥åå–® */
        .btn-export { background-color: #018786; color: white; }
        
        .student-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px; }
        .student-card { border: 1px solid #eee; border-radius: 12px; padding: 15px; text-align: center; background: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        
        .score-display { font-size: 1.8em; font-weight: bold; color: #6200ee; margin: 10px 0; }
        .btn-group { display: flex; gap: 10px; justify-content: center; }
        .btn-plus { background-color: #4caf50; color: white; flex: 1; font-size: 1.2em; }
        .btn-minus { background-color: #f44336; color: white; flex: 1; font-size: 1.2em; }

        .logs-section { margin-top: 30px; border-top: 1px solid #eee; padding-top: 20px; }
        #logList li { list-style: none; padding: 8px; border-bottom: 1px solid #f9f9f9; font-size: 0.9em; display: flex; justify-content: space-between; }
    </style>
</head>
<body>

<div class="container">
    <div class="header-box">
        <h3>ğŸ« èª²å ‚ç®¡ç†ä¸­å¿ƒ</h3>
        <div class="input-group">
            <input type="text" id="classIdInput" placeholder="è«‹è¼¸å…¥ç­ç´š ID (å¦‚: ClassA)">
            <button class="btn-load" onclick="loadClass()">é€²å…¥ç­ç´š</button>
        </div>
        <div class="input-group">
            <input type="file" id="csvFileInput" accept=".csv" style="font-size: 12px;">
            <button class="btn-import" onclick="handleImport()">é¦–æ¬¡åŒ¯å…¥åå–®</button>
            <button class="btn-export" onclick="exportToExcel()">åŒ¯å‡ºæˆç¸¾</button>
        </div>
    </div>

    <div id="mainUI" style="display:none;">
        <input type="text" id="searchInput" placeholder="ğŸ” å¿«é€Ÿæ‰¾å­¸ç”Ÿ..." oninput="renderStudents()" style="width:100%; box-sizing:border-box; margin-bottom:15px;">
        
        <div id="studentGrid" class="student-grid"></div>

        <div class="logs-section">
            <h4>ğŸ“‹ æœ€è¿‘è©•åˆ†ç´€éŒ„</h4>
            <ul id="logList"></ul>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, doc, updateDoc, increment, addDoc, serverTimestamp, onSnapshot, query, where, orderBy, limit, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // --- è«‹åœ¨æ­¤å¡«å…¥æ‚¨çš„ Firebase è¨­å®š ---
    const firebaseConfig = {
        apiKey: "AIzaSyCTUNT7oU2kNhqaF1qSuXjpQVrGJL3BXsc",
        authDomain: "score-a4e5b.firebaseapp.com",
        projectId: "score-a4e5b",
        storageBucket: "score-a4e5b.firebasestorage.app",
        messagingSenderId: "158303926526",
        appId: "1:158303926526:web:2485978b314a5536210daf"

    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    let allStudents = [];
    let currentUnsubscribe = null;

    // 1. é€²å…¥ç­ç´š (ä¸éœ€åŒ¯å…¥ï¼Œç›´æ¥è®€å–å·²æœ‰åå–®)
    window.loadClass = () => {
        const classId = document.getElementById('classIdInput').value.trim();
        if (!classId) return alert("è«‹è¼¸å…¥ç­ç´š ID");
        
        // å„²å­˜åˆ°æœ¬åœ°ï¼Œä¸‹æ¬¡å…è¼¸å…¥ (é¸é…)
        localStorage.setItem('lastClassId', classId);
        
        document.getElementById('mainUI').style.display = 'block';
        startListening(classId);
    };

    // 2. ç›£è½å­¸ç”Ÿåå–®
    window.startListening = (classId) => {
        // å¦‚æœä¹‹å‰æœ‰ç›£è½å™¨ï¼Œå…ˆé—œé–‰å®ƒï¼Œé¿å…é‡è¤‡æ¶ˆè€—æµé‡
        if (currentUnsubscribe) currentUnsubscribe();

        const q = collection(db, "classes", classId, "students");
        currentUnsubscribe = onSnapshot(q, (snapshot) => {
            allStudents = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            if (allStudents.length === 0) {
                alert("æ­¤ç­ç´šå°šç„¡å­¸ç”Ÿåå–®ï¼Œè«‹å…ˆåŸ·è¡Œã€Œé¦–æ¬¡åŒ¯å…¥ã€");
            }
            renderStudents();
        });

        // ç›£è½ Log
        const logQ = query(collection(db, "scoreLogs"), where("classId", "==", classId), orderBy("timestamp", "desc"), limit(5));
        onSnapshot(logQ, (snapshot) => {
            const list = document.getElementById('logList');
            list.innerHTML = snapshot.docs.map(doc => {
                const log = doc.data();
                const time = log.timestamp?.toDate().toLocaleTimeString() || "æ›´æ–°ä¸­...";
                return `<li><span>${time} - <b>${log.studentName}</b></span> <span style="color:${log.change > 0 ? 'green':'red'}">${log.change > 0 ? '+':''}${log.change}</span></li>`;
            }).join('');
        });
    };

    // 3. æ¸²æŸ“æŒ‰éˆ•
    window.renderStudents = () => {
        const term = document.getElementById('searchInput').value.toLowerCase();
        const grid = document.getElementById('studentGrid');
        grid.innerHTML = allStudents
            .filter(s => s.name.includes(term) || s.id.includes(term))
            .map(s => `
                <div class="student-card">
                    <div style="font-size:12px; color:#888;">${s.id}</div>
                    <div style="font-weight:bold; font-size:1.1em;">${s.name}</div>
                    <div class="score-display">${s.totalScore}</div>
                    <div class="btn-group">
                        <button class="btn-minus" onclick="changeScore('${s.id}', '${s.name}', -1)">-</button>
                        <button class="btn-plus" onclick="changeScore('${s.id}', '${s.name}', 1)">+</button>
                    </div>
                </div>
            `).join('');
    };

    // 4. åŠ æ¸›åˆ†é‚è¼¯
    window.changeScore = async (sid, sname, val) => {
        const cid = document.getElementById('classIdInput').value;
        const sRef = doc(db, "classes", cid, "students", sid);
        
        try {
            await updateDoc(sRef, { totalScore: increment(val) });
            await addDoc(collection(db, "scoreLogs"), {
                classId: cid, studentId: sid, studentName: sname, change: val, timestamp: serverTimestamp()
            });
            if (navigator.vibrate) navigator.vibrate(40);
        } catch (e) { alert("æ›´æ–°å¤±æ•—ï¼Œè«‹æª¢æŸ¥è³‡æ–™åº«æ¬Šé™"); }
    };

    // 5. é¦–æ¬¡åŒ¯å…¥ (åªæœ‰ç¬¬ä¸€æ¬¡éœ€è¦æŒ‰)
    window.handleImport = () => {
        const classId = document.getElementById('classIdInput').value;
        const fileInput = document.getElementById('csvFileInput');
        if (!classId || !fileInput.files[0]) return alert("è«‹è¼¸å…¥ç­ç´š ID ä¸¦é¸æ“‡ CSV æª”æ¡ˆ");

        Papa.parse(fileInput.files[0], {
            header: true,
            complete: async (results) => {
                const batch = writeBatch(db);
                results.data.forEach(s => {
                    if(!s.id || !s.name) return;
                    const ref = doc(db, "classes", classId, "students", s.id);
                    batch.set(ref, { id: s.id, name: s.name, totalScore: 0 });
                });
                await batch.commit();
                alert("åŒ¯å…¥æˆåŠŸï¼");
                loadClass(); // è‡ªå‹•é€²å…¥ç­ç´š
            }
        });
    };

    // 6. åŒ¯å‡ºçµç®—
    window.exportToExcel = () => {
        if (allStudents.length === 0) return alert("æ²’æœ‰è³‡æ–™å¯ä»¥åŒ¯å‡º");
        const ws = XLSX.utils.json_to_sheet(allStudents);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "æˆç¸¾å–®");
        XLSX.writeFile(wb, `${document.getElementById('classIdInput').value}_æˆç¸¾.xlsx`);
    };

    // åˆå§‹è¼‰å…¥ï¼šå¦‚æœæœ‰ä¸Šæ¬¡ç´€éŒ„çš„ç­ç´šï¼Œè‡ªå‹•å¡«å…¥
    window.onload = () => {
        const saved = localStorage.getItem('lastClassId');
        if (saved) document.getElementById('classIdInput').value = saved;
    };
</script>
</body>
</html>
