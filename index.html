<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>課堂加分系統 v1.0</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        body { font-family: sans-serif; margin: 0; padding: 20px; background-color: #f0f2f5; }
        .container { max-width: 800px; margin: auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px; }
        
        /* 網格佈局 */
        .student-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; }
        .student-card { border: 1px solid #ddd; border-radius: 8px; padding: 12px; text-align: center; background: #fff; transition: transform 0.1s; }
        .student-card:active { transform: scale(0.95); }
        
        /* 按鈕樣式 */
        .btn-group { display: flex; justify-content: space-around; margin-top: 10px; }
        button { padding: 10px 15px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .btn-plus { background-color: #28a745; color: white; }
        .btn-minus { background-color: #dc3545; color: white; }
        .btn-export { background-color: #007bff; color: white; }
        
        /* 歷史紀錄 */
        .logs-section { margin-top: 30px; background: #f8f9fa; padding: 15px; border-radius: 8px; }
        #logList { list-style: none; padding: 0; font-size: 0.9em; }
        #logList li { padding: 5px 0; border-bottom: 1px solid #eee; }
        .log-plus { color: green; }
        .log-minus { color: red; }
    </style>
</head>
<body>

<div class="container">
    <h2>課堂加分管理系統</h2>
    
    <div class="header">
        <input type="text" id="classIdInput" placeholder="班級代碼 (如: class01)">
        <input type="file" id="csvFileInput" accept=".csv">
        <button onclick="handleImport()">批次匯入 CSV</button>
        <button class="btn-export" onclick="exportToExcel()">匯出分數明細</button>
    </div>

    <input type="text" id="searchInput" placeholder="搜尋學生姓名或學號..." oninput="renderStudents()" style="width:100%; padding:10px; margin-bottom:20px; box-sizing:border-box;">

    <div id="studentGrid" class="student-grid">
        </div>

    <div class="logs-section">
        <h3>最近操作紀錄</h3>
        <ul id="logList"></ul>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, doc, updateDoc, increment, addDoc, serverTimestamp, onSnapshot, query, where, orderBy, limit, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // 1. 請在此處替換為您的 Firebase 設定
    const firebaseConfig = {
        apiKey: "AIzaSyCTUNT7oU2kNhqaF1qSuXjpQVrGJL3BXsc",
        authDomain: "score-a4e5b.firebaseapp.com",
        projectId: "score-a4e5b",
        storageBucket: "score-a4e5b.firebasestorage.app",
        messagingSenderId: "158303926526",
        appId: "1:158303926526:web:2485978b314a5536210daf"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let allStudents = [];

    // --- 功能：匯入 CSV ---
    window.handleImport = async () => {
        const classId = document.getElementById('classIdInput').value;
        const fileInput = document.getElementById('csvFileInput');
        if (!classId || !fileInput.files[0]) return alert("請填寫班級代碼並選擇檔案");

        Papa.parse(fileInput.files[0], {
            header: true,
            complete: async (results) => {
                const batch = writeBatch(db);
                results.data.forEach(s => {
                    if(!s.id) return;
                    const ref = doc(db, "classes", classId, "students", s.id);
                    batch.set(ref, { id: s.id, name: s.name, totalScore: 0 });
                });
                await batch.commit();
                alert("匯入成功！");
                startListening(classId); // 匯入後自動開始監聽
            }
        });
    };

    // --- 功能：監聽與渲染 ---
    window.startListening = (classId) => {
        const q = collection(db, "classes", classId, "students");
        onSnapshot(q, (snapshot) => {
            allStudents = snapshot.docs.map(doc => doc.data());
            renderStudents();
        });

        // 監聽 Log
        const logQ = query(collection(db, "scoreLogs"), where("classId", "==", classId), orderBy("timestamp", "desc"), limit(5));
        onSnapshot(logQ, (snapshot) => {
            const list = document.getElementById('logList');
            list.innerHTML = snapshot.docs.map(doc => {
                const log = doc.data();
                const time = log.timestamp?.toDate().toLocaleTimeString() || "";
                return `<li>${time} - ${log.studentName} <span class="${log.change > 0 ? 'log-plus' : 'log-minus'}">${log.change > 0 ? '+' : ''}${log.change}</span></li>`;
            }).join('');
        });
    };

    window.renderStudents = () => {
        const term = document.getElementById('searchInput').value.toLowerCase();
        const grid = document.getElementById('studentGrid');
        grid.innerHTML = allStudents
            .filter(s => s.name.includes(term) || s.id.includes(term))
            .map(s => `
                <div class="student-card">
                    <b>${s.id}</b><br>${s.name}<br>
                    <span style="font-size:1.4em; color:#007bff">${s.totalScore}</span>
                    <div class="btn-group">
                        <button class="btn-minus" onclick="changeScore('${s.id}', '${s.name}', -1)">-1</button>
                        <button class="btn-plus" onclick="changeScore('${s.id}', '${s.name}', 1)">+1</button>
                    </div>
                </div>
            `).join('');
    };

    // --- 功能：加減分 ---
    window.changeScore = async (sid, sname, val) => {
        const cid = document.getElementById('classIdInput').value;
        const sRef = doc(db, "classes", cid, "students", sid);
        
        await updateDoc(sRef, { totalScore: increment(val) });
        await addDoc(collection(db, "scoreLogs"), {
            classId: cid, studentId: sid, studentName: sname, change: val, timestamp: serverTimestamp()
        });
        if (window.navigator.vibrate) window.navigator.vibrate(50); // 手機震動回饋
    };

    // --- 功能：Excel 匯出 ---
    window.exportToExcel = () => {
        if (allStudents.length === 0) return alert("目前沒有資料可匯出");
        const ws = XLSX.utils.json_to_sheet(allStudents);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "成績單");
        XLSX.writeFile(wb, `班級分數_${new Date().toLocaleDateString()}.xlsx`);
    };
</script>

</body>
</html>
